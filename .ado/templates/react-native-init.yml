#
parameters:
  - name: language
    type: string
  - name: platform
    type: string
  - name: configuration
    type: string
  - name: projectType
    type: string
  - name: additionalRunArguments
    type: string
    default: ''
  - name: useNuGet
    type: boolean
    default: false
  - name: vsComponents
    type: string
    default: ''
  - name: listVsComponents
    type: boolean
    default: false
  - name: installVsComponents
    type: boolean
    default: false
  - name: additionalInitArguments
    type: string
    default: ''
  - name: continueOnBuildFailure
    type: boolean
    default: false

steps:
  - checkout: self # self represents the repo where the initial Pipelines YAML file was found
    clean: true # whether to fetch clean each time
    # fetchDepth: 2 # the depth of commits to ask Git to fetch
    lfs: false # whether to download Git-LFS files
    submodules: false # set to 'true' for a single level of submodules or 'recursive' to get submodules of submodules
    persistCredentials: false # set to 'true' to leave the OAuth token in the Git config after the initial fetch

  - task: CmdLine@2
    displayName: Build project (Release)
    inputs:
      script: npx --no-install react-native run-windows --arch ${{ parameters.platform }} --no-launch --logging --buildLogDirectory $(Build.BinariesDirectory)\${{ parameters.platform }}\${{ parameters.configuration }}\BuildLogs --release ${{ parameters.additionalRunArguments }}
      workingDirectory: $(Agent.BuildDirectory)
    continueOnError: ${{ parameters.continueOnBuildFailure }}
    condition: and(succeeded(), eq('Release', variables['localConfig']))

  - task: CmdLine@2
    displayName: Build project (Debug)
    inputs:
      script: npx --no-install react-native run-windows --arch ${{ parameters.platform }} --no-launch --logging --buildLogDirectory $(Build.BinariesDirectory)\${{ parameters.platform }}\${{ parameters.configuration }}\BuildLogs ${{ parameters.additionalRunArguments }}
      workingDirectory: $(Agent.BuildDirectory)\testcli
    continueOnError: ${{ parameters.continueOnBuildFailure }}
    condition: and(succeeded(), eq('Debug', variables['localConfig']))

  - template: upload-build-logs.yml
    parameters:
      buildLogDirectory: '$(Build.BinariesDirectory)\${{ parameters.platform }}\${{ parameters.configuration }}\BuildLogs'

  - task: CmdLine@2
    displayName: Create bundle testcli
    inputs:
      script: npx --no-install react-native bundle --entry-file index.js --platform windows --bundle-output test.bundle
      workingDirectory: $(Agent.BuildDirectory)\testcli
    condition: and(succeeded(), eq(variables['localProjectType'], 'app'))

  # We are experiencing random package restore failures.
  # We want to uploading the vedaccio logs to aid in diagnosing if it is verdaccio or npmjs.org
  - task: PublishPipelineArtifact@1
    displayName: Upload Verdaccio.log (on failure)
    inputs:
      targetPath: 'verdaccio.log'
      artifact: '$(Agent.JobName).Verdaccio.log-$(System.JobAttempt)'
    condition: failed()

