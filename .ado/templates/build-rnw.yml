# Steps template for building any React Native Windows variant.

parameters:
  debug: false

  # NuGet & MSBuild
  project:
  msbuildVersion: $(MSBuildVersion)
  msBuildArchitecture: $(MSBuildArchitecture)
  preferredToolArchitecture: $(MSBuildPreferredToolArchitecture)
  platformToolset: $(MSBuildPlatformToolset)
  msbuildArguments: ''
  yarnBuildCmd: build
  BuildLogDirectory: $(Build.BinariesDirectory)\$(BuildPlatform)\$(BuildConfiguration)\BuildLogs


  # Visual Studio Installer
  vsComponents: ''
  listVsComponents: false
  installVsComponents: false

steps:
  - template: prepare-env.yml
    parameters:
      vsComponents: ${{ parameters.vsComponents }}
      listVsComponents: ${{ parameters.listVsComponents }}
      installVsComponents: ${{ parameters.installVsComponents }}
      yarnBuildCmd: ${{ parameters.yarnBuildCmd }}
      debug: ${{ parameters.debug }}

  # NuGetCommand@2 workaround: https://developercommunity.visualstudio.com/content/problem/288534/vsts-yaml-build-failure-the-task-name-nugetcommand.html
  - task: 333b11bd-d341-40d9-afcf-b32d5ce6f23b@2
    displayName: NuGet restore
    inputs:
      command: restore
      restoreSolution: ${{parameters.project }}
      feedsToUse: config
      nugetConfigPath: $(Build.SourcesDirectory)/vnext/NuGet.config
      restoreDirectory: packages/
      verbosityRestore: Detailed # Options: quiet, normal, detailed

  - task: VSBuild@1
    displayName: VSBuild ${{parameters.project}}
    inputs:
      solution: ${{parameters.project }}
      vsVersion: ${{parameters.msbuildVersion}}
      msbuildArchitecture: ${{parameters.msBuildArchitecture}}
      platform: $(BuildPlatform)
      configuration: $(BuildConfiguration)
      clean: false # Optional
      maximumCpuCount: false # Optional
      restoreNugetPackages: false # Optional
      createLogFile: true
      logFileVerbosity: detailed
      msbuildArgs:
        /p:PreferredToolArchitecture=${{parameters.preferredToolArchitecture}}
        /p:PlatformToolset=${{parameters.platformToolset}}
        /p:BaseIntDir=$(BaseIntDir)
        /p:PublishToolDuringBuild=true
        /p:EnableSourceLink=true
        /bl:${{ parameters.BuildLogDirectory }}\MsBuild.binlog
        /flp1:errorsonly;logfile=${{ parameters.BuildLogDirectory }}\MsBuild.err
        /flp2:warningsonly;logfile=${{ parameters.BuildLogDirectory }}\MsBuild.wrn
        /flp3:verbosity=diagnostic;logfile=${{ parameters.BuildLogDirectory }}\MsBuild.log
        ${{parameters.msbuildArguments}}

  - template: upload-build-logs.yml
    parameters:
      buildLogDirectory: '${{ parameters.BuildLogDirectory }}'

  - powershell: |
        $winmd2md_url = "https://github.com/asklar/winmd2md/releases/download/v0.1.12/winmd2md.exe"
        Invoke-WebRequest -UseBasicParsing $winmd2md_url -OutFile $env:TEMP\winmd2md.exe
        & $env:TEMP\winmd2md.exe /experimental /outputDirectory vnext\target\winmd2md /apiVersion 0.64 vnext\target\x86\Debug\Microsoft.ReactNative\Microsoft.ReactNative.winmd
    displayName: "Generate WinRT API docs"
    condition: and ( eq('${{parameters.buildConfiguration}}', 'Debug'), eq('${{parameters.buildPlatform}}', 'x86') )
  - task: PublishBuildArtifacts@1
    displayName: Upload WinRT API docs
    condition:  and ( eq('${{parameters.buildConfiguration}}', 'Debug'), eq('${{parameters.buildPlatform}}', 'x86') )
    inputs:
      pathtoPublish: 'vnext\target\winmd2md'
      artifactName: 'WinRT API docs - $(Agent.JobName)-$(System.JobAttempt)'