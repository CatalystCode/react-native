name: $(Date:yyyyMMdd).$(Rev:r)

trigger: none # will disable CI builds entirely

pr:
  - master
  - "*-stable"

variables:
  - template: variables/msbuild.yml
<<<<<<< HEAD
  - template: variables/release.yml
  - template: variables/vs2019.yml
  - name: reactNativeVersion
    value: 0.62.2

jobs:
  - job: Setup
    steps:
      - task: powershell@2
        name: checkPayload
        displayName: "Check if build is required for this PR"
        inputs:
          targetType: filePath
          filePath: .ado/shouldSkipPRBuild.ps1

  - job: RNWUniversalPR
    displayName: Universal PR
||||||| 811c767bf
  - template: variables/vs2019.yml
  - name: reactNativeVersion
    value: 0.62.2

jobs:
  - job: Setup
    steps:
      - task: powershell@2
        name: checkPayload
        displayName: "Check if build is required for this PR"
        inputs:
          targetType: filePath
          filePath: .ado/shouldSkipPRBuild.ps1

  - job: RNWUniversalPR
    displayName: Universal PR
=======
  - group: platform-override-zero-permission-token

stages:
  - stage: Setup
    jobs:
      - job: Setup
        variables:
          - template: variables/vs2019.yml
        steps:
          - task: powershell@2
            name: checkPayload
            displayName: "Check if build is required for this PR"
            inputs:
              targetType: filePath
              filePath: .ado/scripts/shouldSkipPRBuild.ps1

  - stage: Build
    displayName: Build ðŸ”¨
>>>>>>> 64b0f8706de05473456eae6340a4cbcd938baaaa
    dependsOn: Setup
    condition: ne( dependencies.Setup.outputs['checkPayload.shouldSkipPRBuild'], 'True' )
    jobs:
      - template: jobs/universal.yml
        parameters:
          buildEnvironment: PullRequest

<<<<<<< HEAD
      - powershell: |
          Write-Debug "Using expression $($env:GOOGLETESTADAPTERPATHEXPRESSION)"
          Write-Host "##vso[task.setvariable variable=GoogleTestAdapterPath]$(Invoke-Expression $env:GOOGLETESTADAPTERPATHEXPRESSION)"
          Write-Host "Set environment variable to ($env:GoogleTestAdapterPath)"
        displayName: Set GoogleTestAdapterPath

      - task: VSTest@2
        displayName: Run Universal Unit Tests (Native)
        timeoutInMinutes: 5 # Set smaller timeout , due to hangs
        inputs:
          testSelector: testAssemblies
          testAssemblyVer2: |
            Microsoft.ReactNative.Cxx.UnitTests/Microsoft.ReactNative.Cxx.UnitTests.exe
            Mso.UnitTests/Mso.UnitTests.exe
          pathtoCustomTestAdapters: $(GoogleTestAdapterPath)
          searchFolder: $(Build.SourcesDirectory)/vnext/target/$(BuildPlatform)/$(BuildConfiguration)
          runTestsInIsolation: true
          platform: $(BuildPlatform)
          configuration: $(BuildConfiguration)
          publishRunAttachments: true
          collectDumpOn: onAbortOnly
          vsTestVersion: latest
        condition: and(succeeded(), not(startsWith(variables.BuildPlatform, 'arm')))

      - task: VSTest@2
        displayName: Run Universal Unit Tests (Managed)
        timeoutInMinutes: 5 # Set smaller timeout , due to hangs
        inputs:
          testSelector: testAssemblies
          testAssemblyVer2: |
            Microsoft.ReactNative.Managed.UnitTests/Microsoft.ReactNative.Managed.UnitTests/Microsoft.ReactNative.Managed.UnitTests.build.appxrecipe
          searchFolder: $(Build.SourcesDirectory)/vnext/target/$(BuildPlatform)/$(BuildConfiguration)
          runTestsInIsolation: true
          platform: $(BuildPlatform)
          configuration: $(BuildConfiguration)
          publishRunAttachments: true
          collectDumpOn: onAbortOnly
          vsTestVersion: latest
        condition: and(succeeded(), not(startsWith(variables.BuildPlatform, 'arm')))

      - template: templates/publish-build-artifacts-for-nuget.yml
||||||| 811c767bf
      - task: VSTest@2
        displayName: Run Universal Unit Tests (Native)
        timeoutInMinutes: 5 # Set smaller timeout , due to hangs
        inputs:
          testSelector: testAssemblies
          testAssemblyVer2: |
            Microsoft.ReactNative.Cxx.UnitTests/Microsoft.ReactNative.Cxx.UnitTests.exe
            Mso.UnitTests/Mso.UnitTests.exe
          pathtoCustomTestAdapters: $(GoogleTestAdapterPath)
          searchFolder: $(Build.SourcesDirectory)/vnext/target/$(BuildPlatform)/$(BuildConfiguration)
          runTestsInIsolation: true
          platform: $(BuildPlatform)
          configuration: $(BuildConfiguration)
          publishRunAttachments: true
          collectDumpOn: onAbortOnly
          vsTestVersion: latest
        condition: and(succeeded(), not(startsWith(variables.BuildPlatform, 'arm')))

      - task: VSTest@2
        displayName: Run Universal Unit Tests (Managed)
        timeoutInMinutes: 5 # Set smaller timeout , due to hangs
        inputs:
          testSelector: testAssemblies
          testAssemblyVer2: |
            Microsoft.ReactNative.Managed.UnitTests/Microsoft.ReactNative.Managed.UnitTests/Microsoft.ReactNative.Managed.UnitTests.build.appxrecipe
          searchFolder: $(Build.SourcesDirectory)/vnext/target/$(BuildPlatform)/$(BuildConfiguration)
          runTestsInIsolation: true
          platform: $(BuildPlatform)
          configuration: $(BuildConfiguration)
          publishRunAttachments: true
          collectDumpOn: onAbortOnly
          vsTestVersion: latest
        condition: and(succeeded(), not(startsWith(variables.BuildPlatform, 'arm')))

      - template: templates/publish-build-artifacts-for-nuget.yml
=======
      - template: jobs/desktop.yml
>>>>>>> 64b0f8706de05473456eae6340a4cbcd938baaaa
        parameters:
<<<<<<< HEAD
          artifactName: ReactWindows
          layoutHeaders: eq('true', variables['LayoutHeaders'])
          contents: |
            Microsoft.ReactNative\**

      - script: |
          npx --no-install beachball bump --branch origin/$(System.PullRequest.TargetBranch)
        displayName: Bump package versions to align nuget version with npm version
        condition: eq('true', variables['TestMSRNNuget'])

      - task: PowerShell@2
        displayName: Prepare minimum nuget for testing experimental init
        inputs:
          targetType: 'inline'
          script: |
            $pkgJson = Get-Content -Raw -Path .\vnext\package.json | ConvertFrom-Json
            $pkgVersion = $pkgJson.version
            $(Build.SourcesDirectory)\vnext\Scripts\StripAdditionalPlatformsFromNuspec.ps1 -slices ("$(BuildPlatform).$(BuildConfiguration)")
            Copy-Item -Force -Path vnext\Scripts\Microsoft.ReactNative.targets -Destination $(Build.SourcesDirectory)\vnext\target
            nuget pack $(Build.SourcesDirectory)\vnext\Scripts\Microsoft.ReactNative.PR.nuspec -NonInteractive -OutputDirectory $(Build.StagingDirectory)/TestMSRNNuget -Properties "Configuration=Release;CommitId=0;version=$pkgVersion;id=Microsoft.ReactNative;nugetroot=$(Build.StagingDirectory);baseplatform=$(BuildPlatform);baseconfiguration=$(BuildConfiguration)" -Verbosity Detailed
        condition: eq('true', variables['TestMSRNNuget'])

      - task: PublishBuildArtifacts@1
        displayName: "Publish Artifact: TestMSRNNuget"
        inputs:
          artifactName: TestMSRNNuget.$(BuildPlatform).$(BuildConfiguration)
          pathtoPublish: $(Build.StagingDirectory)/TestMSRNNuget
        condition: eq('true', variables['TestMSRNNuget'])

  - job: RNWUniversalOtherProjectsPR
    displayName: Universal Other Projects PR
    dependsOn: Setup
    condition: ne( dependencies.Setup.outputs['checkPayload.shouldSkipPRBuild'], 'True' )
    strategy:
      matrix: # Why we only build some flavors: https://github.com/microsoft/react-native-windows/issues/4308
        X86Debug:
          BuildConfiguration: Debug
          BuildPlatform: x86
        X64Release:
          BuildConfiguration: Release
          BuildPlatform: x64
    pool:
      vmImage: $(VmImage)
    timeoutInMinutes: 60
    cancelTimeoutInMinutes: 5

    steps:
      - checkout: self
        clean: false
        submodules: false

      - template: templates/prepare-env.yml

      - task: NuGetCommand@2
        displayName: NuGet restore - Playground
        inputs:
          command: restore
          restoreSolution: packages/playground/windows/Playground.sln
          verbosityRestore: Detailed # Options: quiet, normal, detailed

      - task: VSBuild@1
        displayName: VSBuild - Playground
        inputs:
          solution: packages/playground/windows/Playground.sln
          vsVersion: $(MSBuildVersion) # Optional. Options: latest, 16.0, 15.0, 14.0, 12.0, 4.0
          msbuildArchitecture: $(MSBuildArchitecture) # Optional. Options: x86, x64
          platform: $(BuildPlatform) # Optional
          configuration: $(BuildConfiguration) # Optional
          clean: true # Optional
          maximumCpuCount: false # Optional
          restoreNugetPackages: false # Optional
          msbuildArgs:
            /p:PreferredToolArchitecture=$(MSBuildPreferredToolArchitecture)
            /p:PlatformToolset=$(MSBuildPlatformToolset)
            /p:BaseIntDir=$(BaseIntDir)
            /p:AppxPackageSigningEnabled=false
||||||| 811c767bf
          artifactName: ReactWindows
          layoutHeaders: eq('true', variables['LayoutHeaders'])
          contents: |
            Microsoft.ReactNative\**

      - script: |
          npx --no-install beachball bump
        displayName: Bump package versions to align nuget version with npm version
        condition: eq('true', variables['TestMSRNNuget'])

      - task: PowerShell@2
        displayName: Prepare minimum nuget for testing experimental init
        inputs:
          targetType: 'inline'
          script: |
            $pkgJson = Get-Content -Raw -Path .\vnext\package.json | ConvertFrom-Json
            $pkgVersion = $pkgJson.version
            $(Build.SourcesDirectory)\vnext\Scripts\StripAdditionalPlatformsFromNuspec.ps1 -slices ("$(BuildPlatform).$(BuildConfiguration)")
            Copy-Item -Force -Path vnext\Scripts\Microsoft.ReactNative.targets -Destination $(Build.SourcesDirectory)\vnext\target
            nuget pack $(Build.SourcesDirectory)\vnext\Scripts\Microsoft.ReactNative.PR.nuspec -NonInteractive -OutputDirectory $(Build.StagingDirectory)/TestMSRNNuget -Properties "Configuration=Release;CommitId=0;version=$pkgVersion;id=Microsoft.ReactNative;nugetroot=$(Build.SourcesDirectory)\vnext\target;baseplatform=$(BuildPlatform);baseconfiguration=$(BuildConfiguration)" -Verbosity Detailed
        condition: eq('true', variables['TestMSRNNuget'])

      - task: PublishBuildArtifacts@1
        displayName: "Publish Artifact: TestMSRNNuget"
        inputs:
          artifactName: TestMSRNNuget.$(BuildPlatform).$(BuildConfiguration)
          pathtoPublish: $(Build.StagingDirectory)/TestMSRNNuget
        condition: eq('true', variables['TestMSRNNuget'])

  - job: RNWUniversalOtherProjectsPR
    displayName: Universal Other Projects PR
    dependsOn: Setup
    condition: ne( dependencies.Setup.outputs['checkPayload.shouldSkipPRBuild'], 'True' )
    strategy:
      matrix: # Why we only build some flavors: https://github.com/microsoft/react-native-windows/issues/4308
        X86Debug:
          BuildConfiguration: Debug
          BuildPlatform: x86
        X64Release:
          BuildConfiguration: Release
          BuildPlatform: x64
    pool:
      vmImage: $(VmImage)
    timeoutInMinutes: 60
    cancelTimeoutInMinutes: 5

    steps:
      - checkout: self
        clean: false
        submodules: false
        
      - template: templates/prepare-env.yml

      - task: NuGetCommand@2
        displayName: NuGet restore - Playground
        inputs:
          command: restore
          restoreSolution: packages/playground/windows/Playground.sln
          verbosityRestore: Detailed # Options: quiet, normal, detailed

      - task: VSBuild@1
        displayName: VSBuild - Playground
        inputs:
          solution: packages/playground/windows/Playground.sln
          vsVersion: $(MSBuildVersion) # Optional. Options: latest, 16.0, 15.0, 14.0, 12.0, 4.0
          msbuildArchitecture: $(MSBuildArchitecture) # Optional. Options: x86, x64
          platform: $(BuildPlatform) # Optional
          configuration: $(BuildConfiguration) # Optional
          clean: true # Optional
          maximumCpuCount: false # Optional
          restoreNugetPackages: false # Optional
          msbuildArgs:
            /p:PreferredToolArchitecture=$(MSBuildPreferredToolArchitecture)
            /p:PlatformToolset=$(MSBuildPlatformToolset)
            /p:BaseIntDir=$(BaseIntDir)
            /p:AppxPackageSigningEnabled=false
=======
          buildEnvironment: PullRequest
  
      - template: jobs/nuget-desktop.yml
>>>>>>> 64b0f8706de05473456eae6340a4cbcd938baaaa

<<<<<<< HEAD
      - task: NuGetCommand@2
        displayName: NuGet restore - Playground Win32
        inputs:
          command: restore
          restoreSolution: packages/playground/windows/Playground-Win32.sln
          verbosityRestore: Detailed # Options: quiet, normal, detailed

      - task: VSBuild@1
        displayName: VSBuild - Playground Win32
        inputs:
          solution: packages/playground/windows/Playground-Win32.sln
          vsVersion: $(MSBuildVersion) # Optional. Options: latest, 16.0, 15.0, 14.0, 12.0, 4.0
          msbuildArchitecture: $(MSBuildArchitecture) # Optional. Options: x86, x64
          platform: $(BuildPlatform) # Optional
          configuration: $(BuildConfiguration) # Optional
          clean: true # Optional
          maximumCpuCount: false # Optional
          restoreNugetPackages: false # Optional
          msbuildArgs:
            /p:PreferredToolArchitecture=$(MSBuildPreferredToolArchitecture)
            /p:PlatformToolset=$(MSBuildPlatformToolset)
            /p:BaseIntDir=$(BaseIntDir)

  - job: RNWSampleAppsPR
    displayName: Sample Apps PR
    dependsOn: Setup
    condition: ne( dependencies.Setup.outputs['checkPayload.shouldSkipPRBuild'], 'True' )
    strategy:
      matrix: # Why we only build some flavors: https://github.com/microsoft/react-native-windows/issues/4308
        #X64Debug:
        #  BuildConfiguration: Debug
        #  BuildPlatform: x64
        X64Release:
          BuildConfiguration: Release
          BuildPlatform: x64
        #X86Debug:
        #  BuildConfiguration: Debug
        #  BuildPlatform: x86
        #X86Release:
        #  BuildConfiguration: Release
        #  BuildPlatform: x86
        #ArmDebug:
        #  BuildConfiguration: Debug
        #  BuildPlatform: ARM
        ArmRelease:
          BuildConfiguration: Release
          BuildPlatform: ARM
        #Arm64Debug:
        #  BuildConfiguration: Debug
        #  BuildPlatform: ARM64
        #Arm64Release:
        #  BuildConfiguration: Release
        #  BuildPlatform: ARM64
    timeoutInMinutes: 60
    cancelTimeoutInMinutes: 5
    pool:
      vmImage: $(VmImage)

    steps:
      - checkout: self
        clean: false
        submodules: false

      - template: templates/prepare-env.yml

      - task: NuGetCommand@2
        displayName: NuGet restore - SampleApps
        inputs:
          command: restore
          restoreSolution: packages/microsoft-reactnative-sampleapps/windows/SampleApps.sln
          verbosityRestore: Detailed # Options: quiet, normal, detailed
        condition: succeeded()

      - task: CmdLine@2
        displayName: run-windows (Debug)
        inputs:
          script: yarn windows --no-packager --no-launch --no-deploy --arch $(BuildPlatform) --logging --msbuildprops BaseIntDir=$(BaseIntDir)
          workingDirectory: packages/microsoft-reactnative-sampleapps
        condition: and(succeeded(), eq(variables['BuildConfiguration'], 'Debug'))

      - task: CmdLine@2
        displayName: run-windows (Release)
        inputs:
          script: yarn windows --no-packager --no-launch --no-deploy --arch $(BuildPlatform) --logging --release --msbuildprops BaseIntDir=$(BaseIntDir)
          workingDirectory: packages/microsoft-reactnative-sampleapps
        condition: and(succeeded(), eq(variables['BuildConfiguration'], 'Release'))

      - task: CmdLine@2
        displayName: Create SampleApp bundle
        inputs:
          script: yarn bundle-cpp
          workingDirectory: packages\microsoft-reactnative-sampleapps
        condition: succeeded()

  - job: RNWDesktopPR
    displayName: Desktop PR
||||||| 811c767bf
      - task: NuGetCommand@2
        displayName: NuGet restore - Playground Win32
        inputs:
          command: restore
          restoreSolution: packages/playground/windows/Playground-Win32.sln
          verbosityRestore: Detailed # Options: quiet, normal, detailed

      - task: VSBuild@1
        displayName: VSBuild - Playground Win32
        inputs:
          solution: packages/playground/windows/Playground-Win32.sln
          vsVersion: $(MSBuildVersion) # Optional. Options: latest, 16.0, 15.0, 14.0, 12.0, 4.0
          msbuildArchitecture: $(MSBuildArchitecture) # Optional. Options: x86, x64
          platform: $(BuildPlatform) # Optional
          configuration: $(BuildConfiguration) # Optional
          clean: true # Optional
          maximumCpuCount: false # Optional
          restoreNugetPackages: false # Optional
          msbuildArgs:
            /p:PreferredToolArchitecture=$(MSBuildPreferredToolArchitecture)
            /p:PlatformToolset=$(MSBuildPlatformToolset)
            /p:BaseIntDir=$(BaseIntDir)

  - job: RNWSampleAppsPR
    displayName: Sample Apps PR
    dependsOn: Setup
    condition: ne( dependencies.Setup.outputs['checkPayload.shouldSkipPRBuild'], 'True' )
    strategy:
      matrix: # Why we only build some flavors: https://github.com/microsoft/react-native-windows/issues/4308
        #X64Debug:
        #  BuildConfiguration: Debug
        #  BuildPlatform: x64
        X64Release:
          BuildConfiguration: Release
          BuildPlatform: x64
        #X86Debug:
        #  BuildConfiguration: Debug
        #  BuildPlatform: x86
        #X86Release:
        #  BuildConfiguration: Release
        #  BuildPlatform: x86
        #ArmDebug:
        #  BuildConfiguration: Debug
        #  BuildPlatform: ARM
        ArmRelease:
          BuildConfiguration: Release
          BuildPlatform: ARM
        #Arm64Debug:
        #  BuildConfiguration: Debug
        #  BuildPlatform: ARM64
        #Arm64Release:
        #  BuildConfiguration: Release
        #  BuildPlatform: ARM64
    timeoutInMinutes: 60
    cancelTimeoutInMinutes: 5
    pool:
      vmImage: $(VmImage)

    steps:
      - checkout: self
        clean: false
        submodules: false
        
      - template: templates/prepare-env.yml

      - task: NuGetCommand@2
        displayName: NuGet restore - SampleApps
        inputs:
          command: restore
          restoreSolution: packages/microsoft-reactnative-sampleapps/windows/SampleApps.sln
          verbosityRestore: Detailed # Options: quiet, normal, detailed
        condition: succeeded()

      - task: CmdLine@2
        displayName: run-windows (Debug)
        inputs:
          script: yarn windows --no-packager --no-launch --no-deploy --arch $(BuildPlatform) --logging --msbuildprops BaseIntDir=$(BaseIntDir)
          workingDirectory: packages/microsoft-reactnative-sampleapps
        condition: and(succeeded(), eq(variables['BuildConfiguration'], 'Debug'))

      - task: CmdLine@2
        displayName: run-windows (Release)
        inputs:
          script: yarn windows --no-packager --no-launch --no-deploy --arch $(BuildPlatform) --logging --release --msbuildprops BaseIntDir=$(BaseIntDir)
          workingDirectory: packages/microsoft-reactnative-sampleapps
        condition: and(succeeded(), eq(variables['BuildConfiguration'], 'Release'))

      - task: CmdLine@2
        displayName: Create SampleApp bundle
        inputs:
          script: yarn bundle-cpp
          workingDirectory: packages\microsoft-reactnative-sampleapps
        condition: succeeded()

  - job: RNWDesktopPR
    displayName: Desktop PR
=======
      - template: jobs/cli-init.yml
        parameters:
          # The Nuget CLI verification is part of 'Build' to speed up the verification
          buildEnvironment: PullRequest
          buildNuGetOnly: true
          
  - stage: IntegrationTests
    displayName: Tests ðŸ§ª
>>>>>>> 64b0f8706de05473456eae6340a4cbcd938baaaa
    dependsOn: Setup
<<<<<<< HEAD
    condition: ne( dependencies.Setup.outputs['checkPayload.shouldSkipPRBuild'], 'True' )
    strategy:
      matrix:
        X64Debug:
          BuildConfiguration: Debug
          BuildPlatform: x64
        X64Release:
          BuildConfiguration: Release
          BuildPlatform: x64
        X86Debug:
          BuildConfiguration: Debug
          BuildPlatform: x86
        X86Release:
          BuildConfiguration: Release
          BuildPlatform: x86
        ARM64Debug:
          BuildConfiguration: Debug
          BuildPlatform: ARM64
        ARM64Release:
          BuildConfiguration: Release
          BuildPlatform: ARM64

    pool:
      vmImage: $(VmImage)
    timeoutInMinutes: 60 # how long to run the job before automatically cancelling
    cancelTimeoutInMinutes: 5 # how much time to give 'run always even if cancelled tasks' before killing them

    variables:
      Desktop.IntegrationTests.Filter: |
        (FullyQualifiedName!=RNTesterIntegrationTests::AsyncStorage)&
        (FullyQualifiedName!=RNTesterIntegrationTests::Dummy)&
        (FullyQualifiedName!=RNTesterIntegrationTests::IntegrationTestHarness)&
        (FullyQualifiedName!=RNTesterIntegrationTests::Logging)&
        (FullyQualifiedName!=RNTesterIntegrationTests::WebSocket)&
        (FullyQualifiedName!=RNTesterIntegrationTests::XHRSample)&
        (FullyQualifiedName!~WebSocketModule_)&
        (FullyQualifiedName!=WebSocketResourcePerformanceTest::ProcessThreadsPerResource)
||||||| 811c767bf
    condition: ne( dependencies.Setup.outputs['checkPayload.shouldSkipPRBuild'], 'True' )
    strategy:
      matrix:
        X64Debug:
          BuildConfiguration: Debug
          BuildPlatform: x64
        X86Debug:
          BuildConfiguration: Debug
          BuildPlatform: x86
        X64Release:
          BuildConfiguration: Release
          BuildPlatform: x64
        X86Release:
          BuildConfiguration: Release
          BuildPlatform: x86

    pool:
      vmImage: $(VmImage)
    timeoutInMinutes: 60 # how long to run the job before automatically cancelling
    cancelTimeoutInMinutes: 5 # how much time to give 'run always even if cancelled tasks' before killing them

    variables:
      Desktop.IntegrationTests.Filter: (FullyQualifiedName!~WebSocketJSExecutorIntegrationTest)&(FullyQualifiedName!~WebSocket)
=======
    condition: ne( dependencies.Setup.outputs['checkPayload.shouldSkipPRBuild'], 'False' )
    jobs:
      - template: jobs/jschecks.yml
>>>>>>> 64b0f8706de05473456eae6340a4cbcd938baaaa

      - template: jobs/macos-tests.yml

<<<<<<< HEAD
      - task: VisualStudioTestPlatformInstaller@1
        inputs:
          testPlatformVersion: 16.5.0

      - template: templates/build-rnw.yml
||||||| 811c767bf
      - task: VisualStudioTestPlatformInstaller@1
        inputs:
          testPlatformVersion: 16.3.0

      - template: templates/build-rnw.yml
=======
      - template: jobs/playground.yml
>>>>>>> 64b0f8706de05473456eae6340a4cbcd938baaaa
        parameters:
<<<<<<< HEAD
          yarnBuildCmd: build
          project: vnext/ReactWindows-Desktop.sln

      - task: CmdLine@2
        displayName: Build react-native-win32 RNTester bundle
        inputs:
          script: yarn bundle
          workingDirectory: packages/react-native-win32
        condition: and(succeeded(), eq(variables['BuildConfiguration'], 'Debug'), eq(variables['BuildPlatform'], 'x64'))

      - powershell: |
          Write-Debug "Using expression $($env:GOOGLETESTADAPTERPATHEXPRESSION)"
          Write-Host "##vso[task.setvariable variable=GoogleTestAdapterPath]$(Invoke-Expression $env:GOOGLETESTADAPTERPATHEXPRESSION)"
          Write-Host "Set environment variable to ($env:GoogleTestAdapterPath)"
        displayName: Set GoogleTestAdapterPath

      - task: VSTest@2
        displayName: Run Desktop Unit Tests
        timeoutInMinutes: 5 # Set smaller timeout , due to hangs
        inputs:
          testSelector: testAssemblies
          testAssemblyVer2: |
            React.Windows.Desktop.UnitTests/React.Windows.Desktop.UnitTests.dll
            JSI.Desktop.UnitTests/JSI.Desktop.UnitTests.exe
          pathtoCustomTestAdapters: $(GoogleTestAdapterPath)
          searchFolder: $(Build.SourcesDirectory)/vnext/target/$(BuildPlatform)/$(BuildConfiguration)
          runTestsInIsolation: true
          platform: $(BuildPlatform)
          configuration: $(BuildConfiguration)
          publishRunAttachments: true
          collectDumpOn: onAbortOnly
          vsTestVersion: toolsInstaller

      - template: templates/stop-packagers.yml

      - task: PowerShell@2
        displayName: Set up test servers
        inputs:
          targetType: filePath # filePath | inline
          filePath: $(Build.SourcesDirectory)\vnext\Scripts\Tfs\Start-TestServers.ps1
          arguments: -SourcesDirectory $(Build.SourcesDirectory)\vnext -Preload -SleepSeconds 120

      - task: VSTest@2
        displayName: Run Desktop Integration Tests
        inputs:
          testSelector: testAssemblies
          testAssemblyVer2: React.Windows.Desktop.IntegrationTests\React.Windows.Desktop.IntegrationTests.dll
          searchFolder: $(Build.SourcesDirectory)\vnext\target\$(BuildPlatform)\$(BuildConfiguration)
          testFiltercriteria: $(Desktop.IntegrationTests.Filter)
          runTestsInIsolation: true
          platform: $(BuildPlatform)
          configuration: $(BuildConfiguration)
          publishRunAttachments: true
          collectDumpOn: onAbortOnly
          vsTestVersion: toolsInstaller
          otherConsoleOptions: '/blame -- RunConfiguration.TestSessionTimeout=300000'
        condition: and(succeeded(), ne(variables['BuildConfiguration'], 'Debug'))

      - task: VSTest@2
        displayName: List Desktop Integration Tests
        inputs:
          testSelector: testAssemblies
          testAssemblyVer2: React.Windows.Desktop.IntegrationTests\React.Windows.Desktop.IntegrationTests.dll
          searchFolder: $(Build.SourcesDirectory)\vnext\target\$(BuildPlatform)\$(BuildConfiguration)
          testFiltercriteria: $(Desktop.IntegrationTests.Filter)
          runTestsInIsolation: false
          platform: $(BuildPlatform)
          configuration: $(BuildConfiguration)
          publishRunAttachments: false
          collectDumpOn: onAbortOnly
          vsTestVersion: toolsInstaller
          otherConsoleOptions: '/ListTests'
        condition: failed()
||||||| 811c767bf
          yarnBuildCmd: build
          project: vnext/ReactWindows-Desktop.sln

      - task: CmdLine@2
        displayName: Build react-native-win32 RNTester bundle
        inputs:
          script: yarn bundle
          workingDirectory: packages/react-native-win32
        condition: and(succeeded(), eq(variables['BuildConfiguration'], 'Debug'), eq(variables['BuildPlatform'], 'x64'))

      - task: VSTest@2
        displayName: Run Desktop Unit Tests
        timeoutInMinutes: 5 # Set smaller timeout , due to hangs
        inputs:
          testSelector: testAssemblies
          testAssemblyVer2: |
            React.Windows.Desktop.UnitTests/React.Windows.Desktop.UnitTests.dll
            JSI.Desktop.UnitTests/JSI.Desktop.UnitTests.exe
          pathtoCustomTestAdapters: $(GoogleTestAdapterPath)
          searchFolder: $(Build.SourcesDirectory)/vnext/target/$(BuildPlatform)/$(BuildConfiguration)
          runTestsInIsolation: true
          platform: $(BuildPlatform)
          configuration: $(BuildConfiguration)
          publishRunAttachments: true
          collectDumpOn: onAbortOnly
          vsTestVersion: toolsInstaller

      - template: templates/stop-packagers.yml

      - task: PowerShell@2
        displayName: Set up test servers
        inputs:
          targetType: filePath # filePath | inline
          filePath: $(Build.SourcesDirectory)\vnext\Scripts\Tfs\Start-TestServers.ps1
          arguments: -SourcesDirectory $(Build.SourcesDirectory)\vnext -Preload -SleepSeconds 120

      - task: VSTest@2
        displayName: Run Desktop Integration Tests
        inputs:
          testSelector: testAssemblies
          testAssemblyVer2: React.Windows.Desktop.IntegrationTests\React.Windows.Desktop.IntegrationTests.dll
          searchFolder: $(Build.SourcesDirectory)\vnext\target\$(BuildPlatform)\$(BuildConfiguration)
          testFiltercriteria: $(Desktop.IntegrationTests.Filter)
          runTestsInIsolation: true
          platform: $(BuildPlatform)
          configuration: $(BuildConfiguration)
          publishRunAttachments: true
          collectDumpOn: onAbortOnly
          vsTestVersion: toolsInstaller
          otherConsoleOptions: '/blame -- RunConfiguration.TestSessionTimeout=300000'
        condition: and(succeeded(), ne(variables['BuildConfiguration'], 'Debug'))

      - task: VSTest@2
        displayName: List Desktop Integration Tests
        inputs:
          testSelector: testAssemblies
          testAssemblyVer2: React.Windows.Desktop.IntegrationTests\React.Windows.Desktop.IntegrationTests.dll
          searchFolder: $(Build.SourcesDirectory)\vnext\target\$(BuildPlatform)\$(BuildConfiguration)
          testFiltercriteria: $(Desktop.IntegrationTests.Filter)
          runTestsInIsolation: false
          platform: $(BuildPlatform)
          configuration: $(BuildConfiguration)
          publishRunAttachments: false
          collectDumpOn: onAbortOnly
          vsTestVersion: toolsInstaller
          otherConsoleOptions: '/ListTests'
        condition: failed()
=======
          buildEnvironment: PullRequest
>>>>>>> 64b0f8706de05473456eae6340a4cbcd938baaaa

      - template: jobs/sample-apps.yml
        parameters:
          buildEnvironment: PullRequest

      - template: jobs/e2e-test.yml
        parameters:
          buildEnvironment: PullRequest

      - template: jobs/integration-test.yml
        parameters:
          buildEnvironment: PullRequest

  - stage: CLI
    displayName: Cli ðŸ–¥
    dependsOn: Setup
<<<<<<< HEAD
    condition: ne( dependencies.Setup.outputs['checkPayload.shouldSkipPRBuild'], 'True' )
    pool:
      vmImage: $(VmImage)
    timeoutInMinutes: 10 # how long to run the job before automatically cancelling
    cancelTimeoutInMinutes: 5 # how much time to give 'run always even if cancelled tasks' before killing them
    steps:
      - checkout: self # self represents the repo where the initial Pipelines YAML file was found
        clean: true # whether to fetch clean each time
        fetchDepth: 2 # the depth of commits to ask Git to fetch
        lfs: false # whether to download Git-LFS files
        submodules: false # set to 'true' for a single level of submodules or 'recursive' to get submodules of submodules
        persistCredentials: false # set to 'true' to leave the OAuth token in the Git config after the initial fetch

      - task: CmdLine@2
        displayName: yarn install
        inputs:
          script: yarn install --frozen-lockfile

      - task: CmdLine@2
        displayName: Check for change files
        inputs:
          script: npx --no-install beachball check --branch origin/$(System.PullRequest.TargetBranch) --changehint "Run `yarn change` from root of repo to generate a change file."

      - task: CmdLine@2
        displayName: yarn format:verify
        inputs:
          script: yarn format:verify

      - task: CmdLine@2
        displayName: yarn buildci
        inputs:
          script: yarn buildci

      - task: CmdLine@2
        displayName: yarn lint
        inputs:
          script: yarn lint

      - task: CmdLine@2
        displayName: yarn test
        inputs:
          script: yarn test

      - task: CmdLine@2
        displayName: yarn validate-overrides
        inputs:
          script: yarn validate-overrides

      - task: CmdLine@2
        displayName: yarn api
        inputs:
          script: yarn api

  - template: templates/e2e-test-job.yml # Template reference
    parameters:
      name: E2ETest
      BuildPlatform: x64

  - job: RNWNugetPR
    displayName: Build and Pack Nuget
    dependsOn:
      - Setup
      - RNWUniversalPR
      - RNWDesktopPR
    condition: ne( dependencies.Setup.outputs['checkPayload.shouldSkipPRBuild'], 'True' )
    pool:
      vmImage: $(VmImage)
    timeoutInMinutes: 30
    cancelTimeoutInMinutes: 5
    steps:
      - checkout: self
        fetchDepth: 15

      # The commit tag in the nuspec requires that we use at least nuget 5.8 (because things break with nuget versions before and Vs 16.8 or later)
      - task: NuGetToolInstaller@0
        inputs:
          versionSpec: ">=5.8.0"

      - template: templates/prep-and-pack-nuget.yml
||||||| 811c767bf
    condition: ne( dependencies.Setup.outputs['checkPayload.shouldSkipPRBuild'], 'True' )
    pool:
      vmImage: $(VmImage)
    timeoutInMinutes: 10 # how long to run the job before automatically cancelling
    cancelTimeoutInMinutes: 5 # how much time to give 'run always even if cancelled tasks' before killing them
    steps:
      - checkout: self # self represents the repo where the initial Pipelines YAML file was found
        clean: true # whether to fetch clean each time
        fetchDepth: 2 # the depth of commits to ask Git to fetch
        lfs: false # whether to download Git-LFS files
        submodules: false # set to 'true' for a single level of submodules or 'recursive' to get submodules of submodules
        persistCredentials: false # set to 'true' to leave the OAuth token in the Git config after the initial fetch

      - task: CmdLine@2
        displayName: yarn install
        inputs:
          script: yarn install --frozen-lockfile

      - task: CmdLine@2
        displayName: Check for change files
        inputs:
          script: npx --no-install beachball check --branch origin/$(System.PullRequest.TargetBranch) --changehint "Run `yarn change` from root of repo to generate a change file."

      - task: CmdLine@2
        displayName: yarn format:verify
        inputs:
          script: yarn format:verify

      - task: CmdLine@2
        displayName: yarn buildci
        inputs:
          script: yarn buildci

      - task: CmdLine@2
        displayName: yarn lint
        inputs:
          script: yarn lint

      - task: CmdLine@2
        displayName: yarn test
        inputs:
          script: yarn test

      - task: CmdLine@2
        displayName: yarn validate-overrides
        inputs:
          script: yarn validate-overrides

      - task: CmdLine@2
        displayName: yarn api
        inputs:
          script: yarn api

  - template: templates/e2e-test-job.yml # Template reference
    parameters:
      name: E2ETest
      BuildPlatform: x64

  - job: RNWNugetPR
    displayName: Build and Pack Nuget
    dependsOn:
      - Setup
      - RNWUniversalPR
      - RNWDesktopPR
    condition: ne( dependencies.Setup.outputs['checkPayload.shouldSkipPRBuild'], 'True' )
    pool:
      vmImage: $(VmImage)
    timeoutInMinutes: 30
    cancelTimeoutInMinutes: 5
    steps:
      - checkout: self
        fetchDepth: 15

      # The commit tag in the nuspec requires that we use at least nuget 4.6
      - task: NuGetToolInstaller@0
        inputs:
          versionSpec: ">=4.6.0"

      - template: templates/prep-and-pack-nuget.yml
=======
    condition: ne( dependencies.Setup.outputs['checkPayload.shouldSkipPRBuild'], 'False' )
    jobs:
      - template: jobs/cli-init.yml
>>>>>>> 64b0f8706de05473456eae6340a4cbcd938baaaa
        parameters:
<<<<<<< HEAD
          slices: '("x64.Release", "x86.Debug", "ARM.Release")'
          packUniversal: false
||||||| 811c767bf
          slices: '("x64.Release", "x86.Debug", "ARM.Debug")'
          packUniversal: false
=======
          buildEnvironment: PullRequest
>>>>>>> 64b0f8706de05473456eae6340a4cbcd938baaaa
