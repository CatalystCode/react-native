<?xml version="1.0" encoding="utf-8"?>
<!-- 
 Copyright (c) Microsoft Corporation. All rights reserved.
 Licensed under the MIT License.. 
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <ReactCommonSrc>$(ReactNativePackageDir)\ReactCommon\</ReactCommonSrc>
    <ReactCommonDest>$(ReactNativeDir)\ReactCommon\</ReactCommonDest>
    <PatchedReactCommonDest>$(ReactNativeWindowsDir)\\DeforkingPatches\ReactCommon\</PatchedReactCommonDest>
  </PropertyGroup>

  <Target Name="EvaluateReactPatchInputs" BeforeTargets="PrepareForBuild">
    <ItemGroup>
      <ReactCommonSrc Include="$(ReactCommonSrc)\**\*.cpp;$(ReactCommonSrc)\**\*.h" />
      <UnpatchedReactCommonSrc Include="@(ReactCommonSrc)" Condition="'$(PATCH_RN)'!='true' OR !Exists('$(PatchedReactCommonDest)\%(RecursiveDir)%(Filename)%(Extension)')" />
      <PatchedReactCommonSrc Include="$(PatchedReactCommonDest)\**" Condition="'$(PATCH_RN)'=='true'"/>

      <!-- Special case to recreate custom header exports in Facebook BUCK logic -->
      <JsiReactHeaderFiles Include="$(ReactCommonSrc)\turbomodule\core\*.h" />
    </ItemGroup>
  </Target>

  <!--
    Visual Studio has its own incremental build logic for simple cases that
    falls over here. Force use of MSBuild logic here.
  -->
  <PropertyGroup>
    <DisableFastUpToDateCheck>True</DisableFastUpToDateCheck>
  </PropertyGroup>

  <Target Name="CopyReactSources"
          AfterTargets="EvaluatePatchInputsOutputs"
          BeforeTargets="PrepareForBuild">
    <Copy SourceFiles="@(UnpatchedReactCommonSrc)"
          DestinationFiles="@(UnpatchedReactCommonSrc->'$(ReactCommonDest)\%(RecursiveDir)%(Filename)%(Extension)')"
          SkipUnchangedFiles="true" />
  </Target>

  <Target Name="CopyPatchedReactCommonSrc"
          AfterTargets="EvaluatePatchInputsOutputs"
          BeforeTargets="PrepareForBuild">
    <Copy SourceFiles="@(PatchedReactCommonSrc)"
          DestinationFiles="@(PatchedReactCommonSrc->'$(ReactCommonDest)\%(RecursiveDir)%(Filename)%(Extension)')"
          SkipUnchangedFiles="true" />
  </Target>

  <Target Name="CopyJsiReactHeaders"
          AfterTargets="EvaluatePatchInputsOutputs"
          BeforeTargets="PrepareForBuild">
    <Copy SourceFiles="@(JsiReactHeaderFiles)"
          DestinationFiles="@(JsiReactHeaderFiles->'$(ReactCommonDest)\jsireact\%(Filename)%(Extension)')"
          SkipUnchangedFiles="true" />
  </Target>

</Project>