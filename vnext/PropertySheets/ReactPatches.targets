<?xml version="1.0" encoding="utf-8"?>
<!-- 
 Copyright (c) Microsoft Corporation. All rights reserved.
 Licensed under the MIT License.. 
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <ReactCommonSrcPath>$(ReactNativePackageDir)\ReactCommon\</ReactCommonSrcPath>
    <ReactCommonDestPath>$(ReactNativeDir)\ReactCommon\</ReactCommonDestPath>
    <ReactCommonPatchesPath>$(ReactNativeWindowsDir)\DeforkingPatches\ReactCommon\</ReactCommonPatchesPath>
  </PropertyGroup>

  <Target Name="EvaluateReactPatchInputs" BeforeTargets="PrepareForBuild">
    <ItemGroup>
      <DeforkingPatchFiles Include="$(ReactCommonPatchesPath)\**" Condition="'$(PATCH_RN)'=='true'"/>
      <ReactCommonSrcFiles Include="$(ReactCommonSrcPath)\**\*.cpp;$(ReactCommonSrcPath)\**\*.h" />
      <UnpatchedReactCommonSrcFiles Include="@(ReactCommonSrcFiles)" Condition="'$(PATCH_RN)'!='true' OR !Exists('$(ReactCommonPatchesPath)\%(RecursiveDir)%(Filename)%(Extension)')" />
      
      <!-- Special case to recreate custom header exports in Facebook BUCK logic -->
      <JsiReactHeaderFiles Include="$(ReactCommonSrcPath)\turbomodule\core\*.h" />
    </ItemGroup>
  </Target>

  <!--
    Visual Studio has its own incremental build logic for simple cases that
    falls over here. Force use of MSBuild logic here.
  -->
  <PropertyGroup>
    <DisableFastUpToDateCheck>True</DisableFastUpToDateCheck>
  </PropertyGroup>

  <Target Name="CopyUnpatchedReactSources"
          AfterTargets="EvaluateReactPatchInputs"
          BeforeTargets="PrepareForBuild">
    <Copy SourceFiles="@(UnpatchedReactCommonSrcFiles)"
          DestinationFiles="@(UnpatchedReactCommonSrcFiles->'$(ReactCommonDestPath)\%(RecursiveDir)%(Filename)%(Extension)')"
          SkipUnchangedFiles="true" />
  </Target>

  <Target Name="CopyDeforkingPatches"
          AfterTargets="EvaluateReactPatchInputs"
          BeforeTargets="PrepareForBuild">
    <Copy SourceFiles="@(DeforkingPatchFiles)"
          DestinationFiles="@(DeforkingPatchFiles->'$(ReactCommonDestPath)\%(RecursiveDir)%(Filename)%(Extension)')"
          SkipUnchangedFiles="true" />
  </Target>

  <Target Name="CopyJsiReactHeaders"
          AfterTargets="EvaluateReactPatchInputs"
          BeforeTargets="PrepareForBuild">
    <Copy SourceFiles="@(JsiReactHeaderFiles)"
          DestinationFiles="@(JsiReactHeaderFiles->'$(ReactCommonDestPath)\jsireact\%(Filename)%(Extension)')"
          SkipUnchangedFiles="true" />
  </Target>

</Project>