<?xml version="1.0" encoding="utf-8"?>
<!-- 
 Copyright (c) Microsoft Corporation. All rights reserved.
 Licensed under the MIT License.. 
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <PatchTargetIncluded>true</PatchTargetIncluded>
    <ReactPackageCommon>$(ReactNativePackageDir)\ReactCommon\</ReactPackageCommon>
    <ReactCommon>$(ReactNativeDir)\ReactCommon\</ReactCommon>
    <DeforkingPatchesCommon>$(ReactNativeWindowsDir)\DeforkingPatches\ReactCommon\</DeforkingPatchesCommon>
  </PropertyGroup>

  <Target Name="EvaluatePatchReactInputsOutputs" BeforeTargets="PrepareForBuild;PoisonUnpatchedHeaders">
    <ItemGroup>
      <DeforkingPatchFiles Include="$(DeforkingPatchesCommon)\**" Condition="'$(PATCH_RN)'=='true'"/>
      <AllReactSourceFiles Include="$(ReactPackageCommon)\**\*.cpp;$(ReactPackageCommon)\**\*.h" />
      <ReactSourceFiles Include="@(AllReactSourceFiles)" Condition="'$(PATCH_RN)'!='true' OR !Exists('$(DeforkingPatchesCommon)\%(RecursiveDir)%(Filename)%(Extension)')" />
      <JsiReactHeaderFiles Include="$(ReactPackageCommon)\turbomodule\core\*.h" />
    </ItemGroup>
  </Target>

  <!--
    Visual Studio has its own incremental build logic for simple cases that
    falls over here. Force use of MSBuild logic here.
  -->
  <PropertyGroup>
    <DisableFastUpToDateCheck>True</DisableFastUpToDateCheck>
  </PropertyGroup>

  <Target Name="CopyReactSources"
          AfterTargets="EvaluatePatchInputsOutputs"
          BeforeTargets="PrepareForBuild">
    <Copy SourceFiles="@(ReactSourceFiles)"
          DestinationFiles="@(ReactSourceFiles->'$(ReactCommon)\%(RecursiveDir)%(Filename)%(Extension)')"
          SkipUnchangedFiles="true" />
  </Target>

  <Target Name="CopyDeforkingPatches"
          AfterTargets="EvaluatePatchInputsOutputs"
          BeforeTargets="PrepareForBuild">
    <Copy SourceFiles="@(DeforkingPatchFiles)"
          DestinationFiles="@(DeforkingPatchFiles->'$(ReactCommon)\%(RecursiveDir)%(Filename)%(Extension)')"
          SkipUnchangedFiles="true" />
  </Target>

  <Target Name="CopyJsiHeaders"
          AfterTargets="EvaluatePatchInputsOutputs"
          BeforeTargets="PrepareForBuild">
    <Copy SourceFiles="@(JsiReactHeaderFiles)"
          DestinationFiles="@(JsiReactHeaderFiles->'$(ReactCommon)\jsireact\%(Filename)%(Extension)')"
          SkipUnchangedFiles="true" />
  </Target>

</Project>